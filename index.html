<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mykonos Trip Coordinator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.95em;
        }

        label .required {
            color: #e74c3c;
        }

        input, select, textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .responses-section {
            margin-top: 40px;
        }

        .responses-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        td {
            padding: 12px 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state p {
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .clear-btn {
            background: #e74c3c;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            margin-top: 10px;
        }

        .clear-btn:hover {
            background: #c0392b;
        }

        .section-header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 1.1em;
            font-weight: 600;
            text-align: center;
        }

        .highlighted-section {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            background: #f8f4ff;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .highlighted-section {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            table {
                font-size: 0.8em;
            }

            th, td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåä Mykonos Trip Coordinator</h1>
            <p>Share your travel details for our group trip</p>
        </div>

        <div class="card">
            <form id="tripForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="name">Name <span class="required">*</span></label>
                        <input type="text" id="name" name="name" required>
                    </div>

                    <div class="form-group">
                        <label for="partySize"># in Party <span class="required">*</span></label>
                        <input type="number" id="partySize" name="partySize" min="1" required>
                    </div>

                    <div class="form-group">
                        <label for="europeArrival">Arrival Date in Europe/UK <span class="required">*</span></label>
                        <input type="date" id="europeArrival" name="europeArrival" required>
                    </div>

                    <div class="form-group">
                        <label for="firstDestination">1st Destination <span class="required">*</span></label>
                        <input type="text" id="firstDestination" name="firstDestination" required>
                    </div>

                    <div class="form-group">
                        <label for="mykonosArrival">Arrival Date in Mykonos <span class="required">*</span></label>
                        <input type="date" id="mykonosArrival" name="mykonosArrival" required>
                    </div>

                    <div class="form-group">
                        <label for="transportation">Method of Transportation <span class="required">*</span></label>
                        <select id="transportation" name="transportation" required>
                            <option value="">Select...</option>
                            <option value="Plane">Plane</option>
                            <option value="Ferry">Ferry</option>
                            <option value="Plane then Ferry">Plane then Ferry</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="form-group full-width">
                        <label for="lodging">Lodging in Mykonos <span class="required">*</span></label>
                        <input type="text" id="lodging" name="lodging" required>
                    </div>

                    <div class="section-header">
                        üéâ Birthday Events
                    </div>

                    <div class="highlighted-section">
                        <div class="form-group">
                            <label for="event1">Sunday Dinner <span class="required">*</span></label>
                            <select id="event1" name="event1" required>
                                <option value="">Select...</option>
                                <option value="Yes">Yes</option>
                                <option value="No">No</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="event2">Monday Birthday Party <span class="required">*</span></label>
                            <select id="event2" name="event2" required>
                                <option value="">Select...</option>
                                <option value="Yes">Yes</option>
                                <option value="No">No</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label for="activities">Other Activities or Interests</label>
                        <textarea id="activities" name="activities" placeholder="e.g., tour, sailing, cliff jumping..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="mykonosDeparture">Mykonos Departure Date <span class="required">*</span></label>
                        <input type="date" id="mykonosDeparture" name="mykonosDeparture" required>
                    </div>

                    <div class="form-group">
                        <label for="nextDestination">Next Destination <span class="required">*</span></label>
                        <input type="text" id="nextDestination" name="nextDestination" required>
                    </div>

                    <div class="form-group full-width">
                        <label for="usDeparture">Departure Date to US <span class="required">*</span></label>
                        <input type="date" id="usDeparture" name="usDeparture" required>
                    </div>

                    <div class="form-group">
                        <label for="whatsapp">WhatsApp Number <span class="required">*</span></label>
                        <input type="tel" id="whatsapp" name="whatsapp" placeholder="+1 234 567 8900" required>
                    </div>

                    <div class="form-group">
                        <label for="groupChat">Add to Group Chat <span class="required">*</span></label>
                        <select id="groupChat" name="groupChat" required>
                            <option value="">Select...</option>
                            <option value="Yes">Yes, add me to the group</option>
                            <option value="No">No, I'll join later</option>
                        </select>
                    </div>
                </div>

                <input type="hidden" id="editingId" name="editingId">
                <button type="submit" class="submit-btn" id="submitBtn">Submit Trip Details</button>
            </form>
        </div>

        <div class="card">
            <h2>‚úèÔ∏è Edit Your Submission</h2>
            <p style="margin-bottom: 15px; color: #666;">Enter your name to find and edit your trip details:</p>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text" id="searchName" placeholder="Enter your name..." style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                <button onclick="searchAndEdit()" style="background: #667eea; color: white; padding: 12px 30px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap;">Find My Submission</button>
            </div>
            <div id="searchMessage" style="margin-top: 10px; font-size: 0.9em;"></div>
        </div>

        <div class="card responses-section">
            <h2>üìã Everyone's Trip Details</h2>
            <div class="table-container">
                <table id="responsesTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th># in Party</th>
                            <th>EU/UK Arrival</th>
                            <th>1st Destination</th>
                            <th>Mykonos Arrival</th>
                            <th>Transportation</th>
                            <th>Lodging</th>
                            <th>Sunday Dinner</th>
                            <th>Monday Birthday</th>
                            <th>Activities</th>
                            <th>Mykonos Departure</th>
                            <th>Next Destination</th>
                            <th>US Departure</th>
                            <th>WhatsApp</th>
                            <th>Group Chat</th>
                        </tr>
                    </thead>
                    <tbody id="responsesBody">
                        <tr class="empty-state">
                            <td colspan="15">
                                <p>No responses yet</p>
                                <p style="font-size: 0.9em; color: #bbb;">Be the first to share your travel details!</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <button class="clear-btn" onclick="clearAllData()">Clear All Data</button>
        </div>
    </div>

    <script>
        // GOOGLE SHEETS CONFIGURATION
        // Replace this with your Google Apps Script Web App URL after deployment
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyBuyLzwGhyt39_l0qjcvVtpySjBtTrxposNCIJtbg2bMfFiICF2klWbjU6VWGfWM9F/exec';
        
        // Load responses when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadResponses();
        });

        // Handle form submission
        document.getElementById('tripForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const editingId = document.getElementById('editingId').value;
            
            // Get form data
            const formData = {
                name: document.getElementById('name').value,
                partySize: document.getElementById('partySize').value,
                whatsapp: document.getElementById('whatsapp').value,
                groupChat: document.getElementById('groupChat').value,
                europeArrival: document.getElementById('europeArrival').value,
                firstDestination: document.getElementById('firstDestination').value,
                mykonosArrival: document.getElementById('mykonosArrival').value,
                transportation: document.getElementById('transportation').value,
                lodging: document.getElementById('lodging').value,
                event1: document.getElementById('event1').value,
                event2: document.getElementById('event2').value,
                activities: document.getElementById('activities').value || 'N/A',
                mykonosDeparture: document.getElementById('mykonosDeparture').value,
                nextDestination: document.getElementById('nextDestination').value,
                usDeparture: document.getElementById('usDeparture').value,
                timestamp: new Date().toISOString()
            };

            // Save to storage
            try {
                if (editingId) {
                    // Update existing response
                    await updateResponse(editingId, formData);
                    alert('‚úÖ Your trip details have been updated!');
                } else {
                    // Check if name already exists
                    const existingResponse = await findResponseByName(formData.name);
                    if (existingResponse) {
                        if (!confirm(`A submission from "${formData.name}" already exists. Do you want to update it?`)) {
                            return;
                        }
                        await updateResponse(existingResponse.id, formData);
                        alert('‚úÖ Your trip details have been updated!');
                    } else {
                        // Save new response
                        await saveResponse(formData);
                        alert('‚úÖ Your trip details have been submitted!');
                    }
                }
                
                // Clear form and reset edit mode
                this.reset();
                document.getElementById('editingId').value = '';
                document.getElementById('submitBtn').textContent = 'Submit Trip Details';
                
                // Reload responses
                await loadResponses();
            } catch (error) {
                alert('‚ùå Error saving response. Please try again.');
                console.error(error);
            }
        });

        // Save response to Google Sheets
        async function saveResponse(data) {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'save',
                        data: data
                    })
                });
                return true;
            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
                throw error;
            }
        }

        // Update existing response in Google Sheets
        async function updateResponse(id, data) {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'update',
                        id: id,
                        data: data
                    })
                });
                return true;
            } catch (error) {
                console.error('Error updating Google Sheets:', error);
                throw error;
            }
        }

        // Get all responses from Google Sheets
        async function getAllResponses() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=get');
                const result = await response.json();
                
                if (result.success) {
                    const responses = result.data;
                    
                    // Debug: Log the first response to see what we're getting
                    if (responses.length > 0) {
                        console.log('Sample response from Google Sheets:', responses[0]);
                    }
                    
                    // Sort by timestamp (most recent first)
                    responses.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    return responses;
                }
                return [];
            } catch (error) {
                console.error('Error getting responses from Google Sheets:', error);
                return [];
            }
        }

        // Load and display responses
        async function loadResponses() {
            const responses = await getAllResponses();
            const tbody = document.getElementById('responsesBody');
            
            if (responses.length === 0) {
                tbody.innerHTML = `
                    <tr class="empty-state">
                        <td colspan="15">
                            <p>No responses yet</p>
                            <p style="font-size: 0.9em; color: #bbb;">Be the first to share your travel details!</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Build table rows
            tbody.innerHTML = responses.map(r => `
                <tr>
                    <td>${escapeHtml(r.name)}</td>
                    <td>${escapeHtml(r.partySize)}</td>
                    <td>${formatDate(r.europeArrival)}</td>
                    <td>${escapeHtml(r.firstDestination)}</td>
                    <td>${formatDate(r.mykonosArrival)}</td>
                    <td>${escapeHtml(r.transportation)}</td>
                    <td>${escapeHtml(r.lodging)}</td>
                    <td>${escapeHtml(r.event1)}</td>
                    <td>${escapeHtml(r.event2)}</td>
                    <td>${escapeHtml(r.activities)}</td>
                    <td>${formatDate(r.mykonosDeparture)}</td>
                    <td>${escapeHtml(r.nextDestination)}</td>
                    <td>${formatDate(r.usDeparture)}</td>
                    <td>${escapeHtml(r.whatsapp || 'N/A')}</td>
                    <td>${escapeHtml(r.groupChat || 'N/A')}</td>
                </tr>
            `).join('');
        }

        // Clear all data
        async function clearAllData() {
            if (!confirm('Are you sure you want to clear all trip data? This cannot be undone.')) {
                return;
            }
            
            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'clear'
                    })
                });
                await loadResponses();
                alert('‚úÖ All data has been cleared.');
            } catch (error) {
                alert('‚ùå Error clearing data. Please try again.');
                console.error(error);
            }
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString || dateString === 'N/A') return 'N/A';
            
            // Handle different date formats
            let date;
            if (typeof dateString === 'string') {
                // Try parsing as-is first
                date = new Date(dateString);
                
                // If that fails and it looks like YYYY-MM-DD, add time
                if (isNaN(date.getTime()) && dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    date = new Date(dateString + 'T00:00:00');
                }
            } else {
                // If it's already a Date object or number
                date = new Date(dateString);
            }
            
            // Check if date is valid
            if (isNaN(date.getTime())) {
                return dateString; // Return original if we can't parse it
            }
            
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Find response by name
        async function findResponseByName(name) {
            const responses = await getAllResponses();
            return responses.find(r => r.name.toLowerCase() === name.toLowerCase());
        }

        // Search and edit function
        async function searchAndEdit() {
            const searchName = document.getElementById('searchName').value.trim();
            const messageDiv = document.getElementById('searchMessage');
            
            if (!searchName) {
                messageDiv.innerHTML = '<span style="color: #e74c3c;">Please enter a name to search.</span>';
                return;
            }
            
            const response = await findResponseByName(searchName);
            
            if (!response) {
                messageDiv.innerHTML = `<span style="color: #e74c3c;">No submission found for "${escapeHtml(searchName)}". Please check the spelling.</span>`;
                return;
            }
            
            // Fill the form with existing data
            document.getElementById('name').value = response.name;
            document.getElementById('partySize').value = response.partySize;
            document.getElementById('whatsapp').value = response.whatsapp || '';
            document.getElementById('groupChat').value = response.groupChat || '';
            document.getElementById('europeArrival').value = response.europeArrival;
            document.getElementById('firstDestination').value = response.firstDestination;
            document.getElementById('mykonosArrival').value = response.mykonosArrival;
            document.getElementById('transportation').value = response.transportation;
            document.getElementById('lodging').value = response.lodging;
            document.getElementById('event1').value = response.event1;
            document.getElementById('event2').value = response.event2;
            document.getElementById('activities').value = response.activities === 'N/A' ? '' : response.activities;
            document.getElementById('mykonosDeparture').value = response.mykonosDeparture;
            document.getElementById('nextDestination').value = response.nextDestination;
            document.getElementById('usDeparture').value = response.usDeparture;
            document.getElementById('editingId').value = response.id;
            
            // Update button text
            document.getElementById('submitBtn').textContent = 'Update Trip Details';
            
            // Show success message and scroll to form
            messageDiv.innerHTML = `<span style="color: #27ae60;">‚úì Found submission for "${escapeHtml(response.name)}". Edit the form above and click "Update Trip Details".</span>`;
            
            // Scroll to top of form
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Allow Enter key in search field
        document.getElementById('searchName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchAndEdit();
            }
        });
    </script>
</body>
</html>
